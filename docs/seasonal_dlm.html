<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Seasonal DLM</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #f8f8f8; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
pre, code { background-color: #f8f8f8; }
code > span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code > span.dt { color: #204a87; } /* DataType */
code > span.dv { color: #0000cf; } /* DecVal */
code > span.bn { color: #0000cf; } /* BaseN */
code > span.fl { color: #0000cf; } /* Float */
code > span.ch { color: #4e9a06; } /* Char */
code > span.st { color: #4e9a06; } /* String */
code > span.co { color: #8f5902; font-style: italic; } /* Comment */
code > span.ot { color: #8f5902; } /* Other */
code > span.al { color: #ef2929; } /* Alert */
code > span.fu { color: #000000; } /* Function */
code > span.er { color: #a40000; font-weight: bold; } /* Error */
code > span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #000000; } /* Constant */
code > span.sc { color: #000000; } /* SpecialChar */
code > span.vs { color: #4e9a06; } /* VerbatimString */
code > span.ss { color: #4e9a06; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #000000; } /* Variable */
code > span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code > span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code > span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code > span.ex { } /* Extension */
code > span.at { color: #c4a000; } /* Attribute */
code > span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code > span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 66px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 71px;
  margin-top: -71px;
}

.section h2 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h3 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h4 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h5 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h6 {
  padding-top: 71px;
  margin-top: -71px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Bayesian Inference for DLMs</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="model_building_simulation.html">Model Building</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Filtering
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="kalman_filter.html">Kalman Filter</a>
    </li>
    <li>
      <a href="particle_filter.html">Bootstrap Particle Filter</a>
    </li>
    <li>
      <a href="particle_gibbs.html">Particle Gibbs</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Parameter Learning
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="gibbs_sampling.html">Gibbs Sampling</a>
    </li>
    <li>
      <a href="pmmh.html">PMMH</a>
    </li>
  </ul>
</li>
<li>
  <a href="forecasting.html">Forecasting</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="FirstOrderDlm.html">First Order DLM</a>
    </li>
    <li>
      <a href="second_order_dlm.html">Linear Growth DLM</a>
    </li>
    <li>
      <a href="seasonal_dlm.html">Seasonal Composed DLM</a>
    </li>
    <li>
      <a href="CorrelatedModel.html">Multivariate DLM</a>
    </li>
    <li>
      <a href="student_t_filtering.html">Student's t-distributed DLM</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Seasonal DLM</h1>

</div>


<div id="simulate-from-a-seasonal-dlm" class="section level1">
<h1>Simulate From a Seasonal DLM</h1>
<p>A seasonal DLM is given by:</p>
<p><span class="math display">\[\begin{align*}
Y_t | \textbf{x}_t = F \textbf{x}_t + v_t, \quad v_t \sim \mathcal{N}(0, V) \\
X_t | \textbf{x}_{t-1} = G \textbf{x}_t + w_t, \quad w_t \sim \mathcal{N}(0, W) \\
X_y \sim \mathcal{N}(m_0, C_0)
\end{align*}\]</span></p>
<p>Where the system evolution matrix is block diagonal, containing rotation matrices. If we define <span class="math inline">\(T\)</span> to be the period of the seasonality then the frequency is, <span class="math inline">\(\omega = 2\pi/T\)</span>, a rotation matrix for the <span class="math inline">\(h^{\textrm{th}}\)</span> harmonic in the system evolution matrix is given by:</p>
<p><span class="math display">\[R(h, \omega) = \begin{pmatrix}\cos(h\omega) &amp; -\sin(h\omega) \\
\sin(h\omega) &amp; \cos(h\omega) 
\end{pmatrix}\]</span></p>
<p>Then the system matrix is:</p>
<p><span class="math display">\[G = \begin{pmatrix} 
R(1, \omega) &amp; 0 &amp; \dots &amp; \dots &amp; 0 \\
0 &amp; R(2, \omega) &amp; 0 &amp; \dots &amp; 0\\
\vdots &amp; 0 &amp; \ddots &amp; &amp;\vdots \\
0 &amp; \dots &amp; 0 &amp; R(h, \omega)
\end{pmatrix}.\]</span></p>
<p>The observation matrix is <span class="math inline">\(1 \times 2h\)</span> dimensional:</p>
<p><span class="math display">\[F = \begin{pmatrix}1 &amp; 0 &amp; 1 &amp; \dots &amp; 1 &amp; 0 \end{pmatrix}.\]</span></p>
<p>We can specify a seasonal model with trend using:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">scala&gt; <span class="kw">import</span> dlm.<span class="fu">model</span>._
<span class="kw">import</span> dlm.<span class="fu">model</span>._

scala&gt; <span class="kw">import</span> cats.<span class="fu">implicits</span>._
<span class="kw">import</span> cats.<span class="fu">implicits</span>._

scala&gt; <span class="kw">val</span> mod = Dlm.<span class="fu">polynomial</span>(<span class="dv">1</span>) |+| Dlm.<span class="fu">seasonal</span>(<span class="dv">24</span>, <span class="dv">3</span>)
mod: dlm.<span class="fu">model</span>.<span class="fu">Dlm</span>.<span class="fu">Model</span> = <span class="fu">Model</span>(&lt;function1&gt;,&lt;function1&gt;)</code></pre></div>
<p>Then we can simulate from the model by supplying parameters and use the provided simulate function:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">scala&gt; <span class="kw">import</span> breeze.<span class="fu">linalg</span>.{DenseMatrix, DenseVector, diag}
<span class="kw">import</span> breeze.<span class="fu">linalg</span>.{DenseMatrix, DenseVector, diag}

scala&gt; <span class="kw">val</span> p = Dlm.<span class="fu">Parameters</span>(
     |   v = <span class="fu">DenseMatrix</span>((<span class="fl">1.0</span>)),
     |   w = <span class="fu">diag</span>(<span class="fu">DenseVector</span>(<span class="fl">0.01</span>, <span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span>, <span class="fl">0.4</span>)),
     |   m0 = DenseVector.<span class="fu">fill</span>(<span class="dv">7</span>)(<span class="fl">0.0</span>),
     |   c0 = <span class="fu">diag</span>(DenseVector.<span class="fu">fill</span>(<span class="dv">7</span>)(<span class="fl">1.0</span>))
     | )
p: dlm.<span class="fu">model</span>.<span class="fu">Dlm</span>.<span class="fu">Parameters</span> =
<span class="fu">Parameters</span>(<span class="fl">1.0</span>  ,<span class="fl">0.01</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>   <span class="fl">0.2</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>   <span class="fl">0.0</span>  <span class="fl">0.4</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>   <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.5</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>   <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.2</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>   <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.1</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>   <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.4</span>  ,<span class="fu">DenseVector</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  )

scala&gt; <span class="kw">val</span> sims = Dlm.<span class="fu">simulateRegular</span>(<span class="dv">0</span>, mod, p).
     |   steps.
     |   <span class="fu">take</span>(<span class="dv">1000</span>).
     |   toArray
sims: Array[(dlm.<span class="fu">model</span>.<span class="fu">Data</span>, breeze.<span class="fu">linalg</span>.<span class="fu">DenseVector</span>[Double])] = Array((<span class="fu">Data</span>(<span class="fl">1.0</span>,Some(<span class="fu">DenseVector</span>(<span class="fl">0.37853218606790606</span>))),<span class="fu">DenseVector</span>(<span class="fl">0.05811076400914117</span>, <span class="fl">0.35564961749897894</span>, <span class="fl">0.0051601381581495185</span>, <span class="fl">0.39458587626099634</span>, -<span class="fl">0.7884362770657393</span>, <span class="fl">0.03359910124607154</span>, -<span class="fl">0.02679424590741779</span>)), (<span class="fu">Data</span>(<span class="fl">2.0</span>,Some(<span class="fu">DenseVector</span>(-<span class="fl">1.087602900837703</span>))),<span class="fu">DenseVector</span>(<span class="fl">0.028337547473018893</span>, <span class="fl">0.1880745728663083</span>, <span class="fl">0.5109452401667003</span>, <span class="fl">0.3641459879898321</span>, <span class="fl">0.09698725691906179</span>, -<span class="fl">0.03358353565980257</span>, <span class="fl">0.2524558290885483</span>)), (<span class="fu">Data</span>(<span class="fl">3.0</span>,Some(<span class="fu">DenseVector</span>(<span class="fl">0.6768210341942604</span>))),<span class="fu">DenseVector</span>(<span class="fl">0.018664050275622363</span>, -<span class="fl">0.31280612303923117</span>, <span class="fl">0.9282362475164767</span>, <span class="fl">0.3897894582558882</span>, -<span class="fl">0.24742256122512052</span>, -<span class="fl">0.6678948608844156</span>, <span class="fl">0.4094036622463147</span>)), (<span class="fu">Data</span>(<span class="fl">4.0</span>,Some(<span class="fu">DenseVector</span>(<span class="fl">0.8198454846245249</span>))),<span class="fu">DenseVector</span>(<span class="fl">0.03825238068337537</span>, -<span class="fl">0.9008194</span>...</code></pre></div>
<p><img src="seasonal_dlm_files/figure-html/simulated-seasonal-1.png" width="672" /></p>
<p>Plot the states:</p>
<p><img src="seasonal_dlm_files/figure-html/seasonal-states-1.png" width="672" /></p>
</div>
<div id="filtering" class="section level1">
<h1>Filtering</h1>
<p>We can perform Kalman Filtering, to learn the distribution of the latent state given the data we have simulated:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">scala&gt; <span class="kw">val</span> filtered = KalmanFilter.<span class="fu">filter</span>(mod, sims.<span class="fu">map</span>(_._<span class="dv">1</span>), p)
filtered: Array[dlm.<span class="fu">model</span>.<span class="fu">KalmanFilter</span>.<span class="fu">State</span>] =
Array(State(<span class="fl">0.0</span>,<span class="fu">DenseVector</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  ,<span class="fu">DenseVector</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  ,None,None,<span class="fl">0.0</span>), State(<span class="fl">1.0</span>,<span class="fu">DenseVector</span>(<span class="fl">0.06580335764691654</span>, <span class="fl">0.07818220710524737</span>, <span class="fl">0.0</span>, <span class="fl">0.09772775888155921</span>, <span class="fl">0.0</span>, <span class="fl">0.0716670231798101</span>, <span class="fl">0.0</span>),<span class="fl">0.83442340</span>...</code></pre></div>
<p><img src="seasonal_dlm_files/figure-html/filtered-seasonal-1.png" width="672" /></p>
</div>
<div id="smoothing" class="section level1">
<h1>Smoothing</h1>
<p>Kalman Smoothing can be performed:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">scala&gt; <span class="kw">val</span> smoothed = Smoothing.<span class="fu">backwardsSmoother</span>(mod)(filtered)
smoothed: Array[dlm.<span class="fu">model</span>.<span class="fu">Smoothing</span>.<span class="fu">SmoothingState</span>] =
Array(<span class="fu">SmoothingState</span>(<span class="fl">0.0</span>,<span class="fu">DenseVector</span>(<span class="fl">0.2400095008799686</span>, -<span class="fl">0.07609910918054139</span>, <span class="fl">0.20021487955593067</span>, -<span class="fl">0.07396845972615765</span>, -<span class="fl">0.05066157940081897</span>, -<span class="fl">0.02443015610737022</span>, <span class="fl">0.04589007827640945</span>),<span class="fl">2.202720025657208</span>     -<span class="fl">0.21014675797618404</span>   ... (<span class="dv">7</span> total)
-<span class="fl">0.6063092608009367</span>   <span class="fl">0.8223020876274192</span>     ...
<span class="fl">0.2859207744476965</span>    <span class="fl">0.08449550252322074</span>    ...
-<span class="fl">0.3093228122380814</span>   -<span class="fl">0.11426829331252988</span>   ...
<span class="fl">0.3031639608726415</span>    <span class="fl">0.1278833438606577</span>     ...
-<span class="fl">0.21034321904467557</span>  -<span class="fl">0.054407578401991855</span>  ...
<span class="fl">0.28692083275407965</span>   <span class="fl">0.14454294143878613</span>    ...,<span class="fu">DenseVector</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span> ...</code></pre></div>
<p><img src="seasonal_dlm_files/figure-html/smoothed-seasonal-1.png" width="672" /></p>
<div id="parameter-learning-using-gibbs-sampling" class="section level2">
<h2>Parameter Learning using Gibbs Sampling</h2>
<p>The system matrix <span class="math inline">\(W\)</span> is diagonal, hence the Inverse Gamma distribution can be used for the observation and system noise matrices in a Gibbs Sampler. The state is sampled using Forward Filtering Backward Sampling (FFBS), then conditional on the state, the system and observation noise matrices are sampled from Inverse Gamma distributions.</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">scala&gt; <span class="kw">val</span> iters = GibbsSampling.<span class="fu">sample</span>(
     |     mod, 
     |     <span class="fu">InverseGamma</span>(<span class="fl">5.0</span>, <span class="fl">4.0</span>), 
     |     <span class="fu">InverseGamma</span>(<span class="fl">17.0</span>, <span class="fl">4.0</span>), 
     |     p, 
     |     sims.<span class="fu">map</span>(_._<span class="dv">1</span>))
iters: breeze.<span class="fu">stats</span>.<span class="fu">distributions</span>.<span class="fu">Process</span>[dlm.<span class="fu">model</span>.<span class="fu">GibbsSampling</span>.<span class="fu">State</span>] = breeze.<span class="fu">stats</span>.<span class="fu">distributions</span>.<span class="fu">MarkovChain</span>$$anon$<span class="dv">1</span>@<span class="dv">74801926</span></code></pre></div>
<p>The diagnostic plots are below:</p>
<div class="figure">
<img src="seasonal_dlm_files/figure-html/seasonal-v-diagnostics-1.png" alt="Traceplot and running mean for posterior distribution of the observation variance parameter, $V$" width="672" />
<p class="caption">
Traceplot and running mean for posterior distribution of the observation variance parameter, <span class="math inline">\(V\)</span>
</p>
</div>
<div class="figure">
<img src="seasonal_dlm_files/figure-html/seasonal-w-diagnostics-1.png" alt="Diagnostic plots for the MCMC chain representing draws from the posterior distribution of the System noise covariance matrix for the simulated seasonal model" width="672" />
<p class="caption">
Diagnostic plots for the MCMC chain representing draws from the posterior distribution of the System noise covariance matrix for the simulated seasonal model
</p>
</div>
</div>
</div>
<div id="forecast-dlm" class="section level1">
<h1>Forecast DLM</h1>
<p>Forecasting a DLM is equivalent to running the Kalman Filter without any observations at the time of interest. We initialise the forecast by using the posterior distribution of the latent state at the time of the last observation, <span class="math inline">\(x_T \sim \mathcal{N}(m_T, C_T)\)</span> and use the values of the parameters identified using Gibbs sampling.</p>
<p>First we take the mean value of the MCMC parameters, assuming that the parameters have been written to a CSV called <code>seasonal_dlm_gibbs.csv</code> with eight columns, <span class="math inline">\(V, W_1,\dots,W_7\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">scala&gt; <span class="kw">import</span> java.<span class="fu">nio</span>.<span class="fu">file</span>.<span class="fu">Paths</span>
<span class="kw">import</span> java.<span class="fu">nio</span>.<span class="fu">file</span>.<span class="fu">Paths</span>

scala&gt; <span class="kw">import</span> kantan.<span class="fu">csv</span>._
<span class="kw">import</span> kantan.<span class="fu">csv</span>._

scala&gt; <span class="kw">import</span> kantan.<span class="fu">csv</span>.<span class="fu">ops</span>._
<span class="kw">import</span> kantan.<span class="fu">csv</span>.<span class="fu">ops</span>._

scala&gt; <span class="kw">import</span> breeze.<span class="fu">stats</span>.<span class="fu">mean</span>
<span class="kw">import</span> breeze.<span class="fu">stats</span>.<span class="fu">mean</span>

scala&gt; <span class="kw">val</span> mcmcChain = Paths.<span class="fu">get</span>(<span class="st">&quot;data/seasonal_dlm_gibbs.csv&quot;</span>)
mcmcChain: java.<span class="fu">nio</span>.<span class="fu">file</span>.<span class="fu">Path</span> = data\seasonal_dlm_gibbs.<span class="fu">csv</span>

scala&gt; <span class="kw">val</span> read = mcmcChain.<span class="fu">asCsvReader</span>[List[Double]](rfc.<span class="fu">withHeader</span>)
read: kantan.<span class="fu">csv</span>.<span class="fu">CsvReader</span>[kantan.<span class="fu">csv</span>.<span class="fu">ReadResult</span>[List[Double]]] = kantan.<span class="fu">codecs</span>.<span class="fu">resource</span>.<span class="fu">ResourceIterator</span>$$anon$<span class="dv">6</span>@67c5d28f

scala&gt; <span class="kw">val</span> params: List[Double] = read.
     |   collect { <span class="kw">case</span> <span class="fu">Success</span>(a) =&gt; a }.
     |   toList.
     |   transpose.
     |   <span class="fu">map</span>(a =&gt; <span class="fu">mean</span>(a))
params: List[Double] = List(<span class="fl">0.8845079756307068</span>, <span class="fl">0.14898898017307993</span>, <span class="fl">0.2796182358596836</span>, <span class="fl">0.28173619914799153</span>, <span class="fl">0.2758751247272198</span>, <span class="fl">0.2816157274900601</span>, <span class="fl">0.2519573345917604</span>, <span class="fl">0.24110852919544112</span>)

scala&gt; <span class="kw">val</span> meanParameters = Dlm.<span class="fu">Parameters</span>(
     |   <span class="fu">DenseMatrix</span>(params.<span class="fu">head</span>), 
     |   <span class="fu">diag</span>(<span class="fu">DenseVector</span>(params.<span class="fu">tail</span>.<span class="fu">toArray</span>)), 
     |   p.<span class="fu">m0</span>,
     |   p.<span class="fu">c0</span>)
meanParameters: dlm.<span class="fu">model</span>.<span class="fu">Dlm</span>.<span class="fu">Parameters</span> =
<span class="fu">Parameters</span>(<span class="fl">0.8845079756307068</span>  ,<span class="fl">0.14898898017307993</span>  <span class="fl">0.0</span>                 <span class="fl">0.0</span>                  ... (<span class="dv">7</span> total)
<span class="fl">0.0</span>                  <span class="fl">0.2796182358596836</span>  <span class="fl">0.0</span>                  ...
<span class="fl">0.0</span>                  <span class="fl">0.0</span>                 <span class="fl">0.28173619914799153</span>  ...
<span class="fl">0.0</span>                  <span class="fl">0.0</span>                 <span class="fl">0.0</span>                  ...
<span class="fl">0.0</span>                  <span class="fl">0.0</span>                 <span class="fl">0.0</span>                  ...
<span class="fl">0.0</span>                  <span class="fl">0.0</span>                 <span class="fl">0.0</span>                  ...
<span class="fl">0.0</span>                  <span class="fl">0.0</span>                 <span class="fl">0.0</span>                  ...,<span class="fu">DenseVector</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="dv">0</span>...</code></pre></div>
<p>When then use these parameters to get the posterior distribution of the final state:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">scala&gt;   <span class="kw">val</span> filtered = KalmanFilter.<span class="fu">filter</span>(mod, sims.<span class="fu">map</span>(_._<span class="dv">1</span>), meanParameters)
filtered: Array[dlm.<span class="fu">model</span>.<span class="fu">KalmanFilter</span>.<span class="fu">State</span>] =
Array(State(<span class="fl">0.0</span>,<span class="fu">DenseVector</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  ,<span class="fu">DenseVector</span>(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),<span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  <span class="fl">0.0</span>
<span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">0.0</span>  <span class="fl">1.0</span>  ,None,None,<span class="fl">0.0</span>), State(<span class="fl">1.0</span>,<span class="fu">DenseVector</span>(<span class="fl">0.07446211409884738</span>, <span class="fl">0.08292775712017399</span>, <span class="fl">0.0</span>, <span class="fl">0.08268517866812634</span>, <span class="fl">0.0</span>, <span class="fl">0.08113514707618665</span>, <span class="fl">0.0</span>),<span class="fl">0.9229681</span>...

scala&gt;   <span class="kw">val</span> (mt, ct, initTime) = filtered.<span class="fu">map</span>(a =&gt; (a.<span class="fu">mt</span>, a.<span class="fu">ct</span>, a.<span class="fu">time</span>)).<span class="fu">last</span>
mt: breeze.<span class="fu">linalg</span>.<span class="fu">DenseVector</span>[Double] = <span class="fu">DenseVector</span>(<span class="fl">3.1392595732137902</span>, -<span class="fl">0.15216093866250535</span>, -<span class="fl">5.692758776168203</span>, -<span class="fl">1.234877590180563</span>, <span class="fl">11.637056307283837</span>, <span class="fl">3.7319774365161087</span>, <span class="fl">3.2993882181639296</span>)
ct: breeze.<span class="fu">linalg</span>.<span class="fu">DenseMatrix</span>[Double] =
<span class="fl">1.4824923547284103</span>   -<span class="fl">0.5079954882956018</span>   -<span class="fl">0.9844789894569338</span>  ... (<span class="dv">7</span> total)
-<span class="fl">0.5079954882956017</span>  <span class="fl">2.3938974914696387</span>    -<span class="fl">0.3161714269117561</span>  ...
-<span class="fl">0.9844789894569342</span>  -<span class="fl">0.31617142691175604</span>  <span class="fl">3.2787915997106905</span>   ...
-<span class="fl">0.4705834380671068</span>  -<span class="fl">0.9062770408728755</span>   <span class="fl">0.8922250858640552</span>   ...
-<span class="fl">0.2975488930219069</span>  -<span class="fl">0.9560703098100984</span>   -<span class="fl">0.1781542556845435</span>  ...
-<span class="fl">0.3476505885453832</span>  -<span class="fl">0.6942286459009825</span>   <span class="fl">0.30571047004505203</span>  ...
<span class="fl">0.06742023869212262</span>  <span class="fl">0.02013481934000952</span>   -<span class="fl">0.2811795486093878</span>  ...
initTime: dlm.<span class="fu">model</span>.<span class="fu">Time</span> = <span class="fl">1000.0</span></code></pre></div>
<p>We then initialise the forecast function with state state posterior at the time of the last observation:</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala">scala&gt;   <span class="kw">val</span> forecasted = Dlm.<span class="fu">forecast</span>(mod, mt, ct, initTime, meanParameters).
     |     <span class="fu">take</span>(<span class="dv">100</span>).
     |     toList
forecasted: List[(dlm.<span class="fu">model</span>.<span class="fu">Time</span>, Double, Double)] = List((<span class="fl">1000.0</span>,<span class="fl">5.48419848088683</span>,<span class="fl">1.60512413134061</span>), (<span class="fl">1001.0</span>,-<span class="fl">6.76334702289072</span>,<span class="fl">964.5423462993369</span>), (<span class="fl">1002.0</span>,<span class="fl">4.5367965986221375</span>,<span class="fl">1919.5370269888276</span>), (<span class="fl">1003.0</span>,<span class="fl">13.366284157726469</span>,<span class="fl">2885.383255540375</span>), (<span class="fl">1004.0</span>,-<span class="fl">8.14094967767946</span>,<span class="fl">3852.8401892725688</span>), (<span class="fl">1005.0</span>,<span class="fl">11.239908127768334</span>,<span class="fl">4789.02559567327</span>), (<span class="fl">1006.0</span>,<span class="fl">10.337446744884856</span>,<span class="fl">5755.52830011983</span>), (<span class="fl">1007.0</span>,<span class="fl">5.096553132055927</span>,<span class="fl">6711.793895470083</span>), (<span class="fl">1008.0</span>,<span class="fl">5.096553132055927</span>,<span class="fl">7675.885088224641</span>), (<span class="fl">1009.0</span>,<span class="fl">10.337446744884849</span>,<span class="fl">8640.049417014416</span>), (<span class="fl">1010.0</span>,<span class="fl">11.23990812776836</span>,<span class="fl">9600.134617647604</span>), (<span class="fl">1011.0</span>,-<span class="fl">8.140949677679439</span>,<span class="fl">10582.600354655138</span>), (<span class="fl">1012.0</span>,<span class="fl">13.366284157726412</span>,<span class="fl">11560.676778282743</span>), (<span class="fl">1013.0</span>,<span class="fl">4.5367965986222</span>,<span class="fl">12513.907668438816</span>), (<span class="fl">1014.0</span>,-<span class="fl">6.763347022890732</span>,<span class="fl">13472.208337275617</span>), (<span class="fl">1015.0</span>,<span class="fl">5.484198480886894</span>,<span class="fl">14428.348233815</span>...</code></pre></div>
<p>The results of the forecasting and 95% prediction intervals are below:</p>
<p><img src="seasonal_dlm_files/figure-html/forecast_seasonal_dlm-1.png" width="672" /></p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
