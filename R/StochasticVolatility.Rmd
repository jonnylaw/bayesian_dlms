---
title: "DLM with Time Varying Measurement Noise"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(coda)
library(ggmcmc)
library(patchwork)
library(latex2exp)

theme_set(theme_minimal())
```

# Simulation

$$\begin{align}
	Y_t &= x_t + v_t, \\
	v_t &= \sigma \exp\left\{ \frac{alpha_t}{2} \right\} \\
	\alpha_t &= \phi \alpha_{t-1} + \eta, \quad \eta \sim \mathcal{N}(0, 1)
	X_t &= x_{t-1} + w_t, \quad w_t \sim \mathcal{N}(0, W), \\
	X_0 &\sim \mathcal{N}(m_0, C_0), \alpha_0 \sim \mathcal{N}(0, \sigma^2/(1-\phi^2)).
\end{align}$$

```tut:silent
import core.dlm.model._
import breeze.linalg.{DenseMatrix, DenseVector, diag}

val mod = Dlm.polynomial(1)
val p = Dlm.Parameters(
  v = DenseMatrix(2.0),
  w = DenseMatrix(3.0),
  m0 = DenseVector(0.0),
  c0 = DenseMatrix(1.0)
)

val data = StochasticVolatility.simulate(0, mod, p, 1.0).
  steps.
  take(1000).
  toVector
```

The figure below shows a plot of 100 simulations from a first order DLM with a time varying variance.

```{r first-order-simulated}
data = read_csv("../core/data/first_order_dlm_var.csv")

data %>%
  gather(key, value, -time) %>%
  ggplot(aes(x = time, y = value, colour = key)) +
  geom_line() +
  theme(legend.position = "bottom") +
    labs(title = "Simulated values from the first order DLM with Dynamic Variance",
         subtitle = TeX("$$W = 3$, \phi = 2$")) +
    facet_wrap(~key, ncol = 1, scales = "free_y")
```

```{r first-order-simulated}
iters = read_csv("../core/data/first_order_dlm_var_params.csv")

params = ggs(mcmc(gibbs_iters))

p1 = params %>%
  inner_join(actual_values) %>%
  ggplot(aes(x = Iteration, y = value)) +
  geom_line() +
  geom_hline(aes(yintercept = actual_value), colour = "#ff0000") +
  facet_wrap(~Parameter, scales = "free_y")

p2 = params %>% 
  ggs_autocorrelation()

p1 + p2 + plot_layout(ncol = 1)
```

