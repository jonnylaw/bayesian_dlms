---
title: "DLM with Time Varying Measurement Noise"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(coda)
library(ggmcmc)
library(patchwork)
library(latex2exp)

theme_set(theme_minimal())
```

# Simulation

$$\begin{align}
	Y_t &= \sigma_t \exp\left\{ \frac{\alpha_t}{2} \right\}, & \sigma_t &\sim \mathcal{N}(0, 1), \\
	\alpha_t &= \mu + \phi (\alpha_{t-1} - \mu) + \eta_t, & \eta_t &\sim \mathcal{N}(0, \sigma_\eta), \\
	\alpha_0 &\sim \mathcal{N}(0, \sigma^2/(1-\phi^2)).
\end{align}$$

```tut:silent
import core.dlm.model._
import breeze.linalg.{DenseMatrix, DenseVector, diag}

val mod = Dlm.polynomial(1)
val p = Dlm.Parameters(
  v = DenseMatrix(2.0),
  w = DenseMatrix(3.0),
  m0 = DenseVector(0.0),
  c0 = DenseMatrix(1.0)
)

val data = StochasticVolatility.simulate(0, mod, p, 1.0).
  steps.
  take(1000).
  toVector
```

The figure below shows a plot of 100 simulations from a first order DLM with a time varying variance.

```{r stochastic-volatility-simulated}
data = read_csv("../examples/data/sv_sims.csv")

data %>%
  gather(key, value, -time) %>%
  ggplot(aes(x = time, y = value, colour = key)) +
  geom_line() +
  theme(legend.position = "bottom") +
    labs(title = "Simulated values from the first order DLM with Dynamic Variance",
         subtitle = TeX("$\\phi = 0.8$, $\\sigma = 0.2$")) +
    facet_wrap(~key, ncol = 1, scales = "free_y")
```

```{r stochastic-volatility-parameters}
chain1 = read_csv("../examples/data/sv_params_0.csv", col_names = c("phi", "mu", "sigmaEta"))
chain2 = read_csv("../examples/data/sv_params_1.csv", col_names = c("phi", "mu", "sigmaEta"))

indices = seq(from = 1, to = nrow(chain1), by = 10)
params = ggs(mcmc.list(mcmc(chain1[indices,]), mcmc(chain2[indices,])))

p1 = params %>%
    ggplot(aes(x = Iteration, y = value, colour = as.factor(Chain))) +
    geom_line(alpha = 0.6) +
    facet_wrap(~Parameter, scales = "free_y") +
    theme(legend.position = "none")

p2 = params %>% 
  filter(Chain == 1) %>%
  ggs_autocorrelation() +
  theme(legend.position = "none") +
  facet_wrap(~Parameter, ncol = 3)

p3 = ggs_density(params) + facet_wrap(~Parameter, ncol = 3, scales = "free")

p1 / p2 / p3
```

## Heteroskedastic First Order DLM 

A stochastic volatility model can be used to model the variance of a dynamic linear model, allowing for heteroskedasticity.

$$\begin{align}
Y_t &= F_t \theta_t + v_t, &v_t &\sim \textrm{ISV}_p(\phi, \mu, \sigma_\eta), \\
\theta_t &= G_t \theta_{t-1} + w_t,& w_t &\sim \mathcal{N}(0, W), \\
\theta_0 &\sim \mathcal{N}(m_0, C_0).
\end{align}$$

The observation variance matrix is a $p \times p$ diagonal matrix, with time varying variance.

```{r dlm-sv-plot}
sims = read_csv("../examples/data/first_order_dlm_var.csv")

sims %>%
  gather(key, value, -time) %>%
  ggplot(aes(x = time, y = value, colour = key)) +
  geom_line() +
  theme(legend.position = "bottom") +
    labs(title = "Simulated values from the first order DLM with Dynamic Variance",
         subtitle = TeX("$W = 3$, $\\phi = 0.8$, $\\sigma = 0.2$")) +
    facet_wrap(~key, ncol = 1, scales = "free_y")
```

```{r dlm-sv-parameters}
iters = read_csv("../examples/data/first_order_dlm_var_params.csv")

burn = 1e3
thin = 20
params = ggs(mcmc(iters[seq(burn, to = nrow(iters), by = thin),]))

p1 = params %>%
  ggplot(aes(x = Iteration, y = value)) +
  geom_line() +
  facet_wrap(~Parameter, scales = "free_y")

p2 = params %>% 
  ggs_autocorrelation()

p3 = ggs_density(params) + facet_wrap(~Parameter, ncol = 3, scales = "free")

p1 / p2 / p3
```

## Factor Stochastic Volatility with Dynamic Mean

Factor Stochastic volatility models typically model centered data. Combining the DLM with the FSV model allows us to model multivariate non-centered time series.

```{r dlm-fsv-sims}
sims = read_csv("../examples/data/dlm_fsv_sims.csv")

sims %>%
    gather(key, value, -time) %>%
    ggplot(aes(x = time, y = value)) +
    geom_line() +
    facet_wrap(~key, scales = "free_y")
```

```{r dlm-fsv-params}
param_names = c(paste0("v", 1:6),
                paste0("w", 1:6),
                paste0("m0", 1:6),
                paste0("c0", 1:6),
                "sigma",
                paste0("beta", 1:12),
                paste0(c("phi", "mu", "sigma_eta"), rep(1:2, each = 3)))
chain1 = read_csv("../examples/data/dlm_fsv_params_0.csv", col_names = param_names)
chain2 = read_csv("../examples/data/dlm_fsv_params_1.csv", col_names = param_names)

indices = seq(from = 1, to = nrow(chain1), by = 10)
params = ggs(mcmc.list(mcmc(chain1[indices,]), mcmc(chain2[indices,])))

p1 = params %>%
    ggplot(aes(x = Iteration, y = value, colour = as.factor(Chain))) +
    geom_line(alpha = 0.6) +
    facet_wrap(~Parameter, scales = "free_y") +
    theme(legend.position = "none")

p2 = params %>% 
  ggs_autocorrelation()

p3 = ggs_density(params) + facet_wrap(~Parameter, ncol = 3, scales = "free")

p1 / p2 / p3
```

## Continuous Time Stochastic Volatility Models

In order to model irregularly observed data, the AR(1) latent state can be replaced by a continuous time diffusion process, the Ornstein-Uhlenbeck Process which is also a mean reverting process. The diffusion equation can be written as:

$$d\alpha_t = \phi (\mu - \alpha_t) \, dt + \sigma_\eta \, dW_t$$

The Markov transition kernel of this diffusion equation can be written as a Gaussian distribution, then $\alpha(t_i) \sim \mathcal{N}(\mu + \exp(-\phi \textrm{d}t)(\alpha(t_{i-1}) - \mu, \frac{\sigma_\eta}{2\phi}(1 - \exp(-2\phi\textrm{d}t)))$, where $\textrm{d}t = t_i - t_{i-1}$. The figure below shows a simulation from a stochastic volatility model with the latent log-volatility modelled using an OU, the time series is observed at uniformly random times. The time of the observations is not considered to affect the evolution of the time series.

```{r irregular-stochastic-volatility}
sims = read_csv("../examples/data/sv_ou_sims.csv")

sims %>%
  filter(time < 100) %>%
  ggplot() +
  geom_line(aes(x = time, y = `log-variance`)) +
  geom_point(aes(x = time, y = observation), shape = 4) +
  theme_minimal() +
  labs(title = "Irregularly Observed Stochastic Volatility Model",
       subtitle = TeX("$\\phi = 0.2, \\sigma_{\\eta} = 0.2, \\mu = 1.0"))
```

```{r sv-ou-params}
actual_params = tibble(
  Parameter = c("phi", "mu", "sigma"),
  actual_value = c(0.2, 1.0, 0.3)
)
chain1 = read_csv("../examples/data/sv_ou_params_0.csv", col_names = actual_params$Parameter)
chain2 = read_csv("../examples/data/sv_ou_params_1.csv", col_names = actual_params$Parameter)

indices = seq(from = 10000, to = nrow(chain1), by = 10)
params = ggs(mcmc.list(mcmc(chain1[indices,]), mcmc(chain2[indices,])))

p1 = params %>%
    ggplot(aes(x = Iteration, y = value, colour = as.factor(Chain))) +
    geom_line(alpha = 0.6) +
    facet_wrap(~Parameter, scales = "free_y") +
    theme(legend.position = "none")

p2 = params %>% 
  filter(Chain == 1) %>%
  ggs_autocorrelation() +
  facet_wrap(~Parameter, ncol = 3, scales = "free") +
  theme(legend.position = "none")

p3 = ggs_density(params) + 
  facet_wrap(~Parameter, ncol = 3, scales = "free") +
  theme(legend.position = "none")

p1 / p2 / p3
```


