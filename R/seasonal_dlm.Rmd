---
title: "Seasonal DLM"
---

```{r setup, include=FALSE}
library(tidyverse)
library(coda)
library(ggmcmc)
knitr::opts_chunk$set(cache=TRUE, message=FALSE, warning=FALSE)
theme_set(theme_minimal())
```

# Simulate From a Seasonal DLM

```{r simulated-seasonal}
sims = read_csv("../data/seasonal_dlm.csv")

sims %>%
  ggplot(aes(x = time, y = observation)) +
  geom_line() +
  labs(title = "Simulated observations from a seasonal DLM",
       subtitle = "With V = 1.0, W = diag(0.01, 0.2, 0.4, 0.5, 0.2, 0.1, 0.4)")
```

Plot the states:

```{r seasonal-states}
sims %>%
  select(time, contains("state")) %>%
  gather(key, value, -time) %>%
  ggplot(aes(x = time, y = value)) +
  geom_line() +
  facet_wrap(~key, scales = "free_y", strip.position = "right", ncol = 1) +
  labs(title = "Simulated States of the Seasonal DLM",
       subtitle = "Each dimension of the 7D state plotted against time")
```

# Filtering

```{r filtered-seasonal}
filtered = read_csv("../data/seasonal_filtered.csv")

filtered %>%
  inner_join(sims, by = "time") %>%
  filter(time > 900) %>%
  mutate(upper = qnorm(p = 0.95, mean = state_mean_2, sd = sqrt(state_variance_2))) %>%
  mutate(lower = qnorm(p = 0.05, mean = state_mean_2, sd = sqrt(state_variance_2))) %>%
  gather(key, value, state_mean_2, state2) %>%
  ggplot(aes(x = time, y = value, colour = key)) +
  geom_line() +
  geom_line(aes(x = time, y = lower), linetype = 3, colour = "#000000") +
  geom_line(aes(x = time, y = upper), linetype = 3, colour = "#000000") +
  theme(legend.position = "bottom") +
  labs(title = "Kalman Filtering the Seasonal Model", 
       subtitle = "Mean of the Filtering Distribution overlayed with the actual simulated state with 90% probability intervals")
```

# Smoothing


```{r smoothed-seasonal}
smoothed = read_csv("../data/seasonal_smoothed.csv")

smoothed %>%
  filter(time < 500) %>%
  inner_join(sims, by = "time") %>%
  mutate(upper_smoothed = qnorm(p = 0.975, mean = state_mean_1, sd = sqrt(state_variance_1))) %>%
  mutate(lower_smoothed = qnorm(p = 0.025, mean = state_mean_1, sd = sqrt(state_variance_1))) %>%
  gather(key, value, state1, state_mean_1) %>%
  ggplot(aes(x = time, y = value, colour = key)) +
  geom_line() +
  geom_line(aes(x = time, y = lower_smoothed), linetype = 2, colour = "#000000") +
  geom_line(aes(x = time, y = upper_smoothed), linetype = 2, colour = "#000000") +
  theme(legend.position = "bottom") +
  labs(title = "Smoothed State Estimate",
       subtitle = "Actual state and smoothed state, with associated 95% intervals")
```

## Parameter Learning using Gibbs Sampling

```{r parameter_values, echo=FALSE}
actual_values = tibble(
  Parameter = c("V", paste0("W", 1:7)),
  actual_value = c(1.0, 0.01, 0.2, 0.4, 0.5, 0.2, 0.1, 0.4)
)
```

```{r seasonal-v-diagnostics, echo=FALSE, fig.cap="Traceplot and running mean for posterior distribution of the observation variance parameter, $V$"}
iters = read_csv("../data/seasonal_dlm_gibbs.csv")

params = mcmc(iters) %>%
  ggs() %>%
  inner_join(actual_values, by = "Parameter")

p1 = params %>%
  filter(Parameter == "V") %>%
  ggplot(aes(x = Iteration, y = value)) +
  geom_line() +
  geom_hline(aes(yintercept = actual_value), colour = "#ff0000")

p2 = params %>%
  filter(Parameter == "V") %>%
  mutate(running_mean = dlm::ergMean(value)) %>%
  ggplot(aes(x = Iteration, y = running_mean)) +
  geom_line() +
  geom_hline(aes(yintercept = actual_value), colour = "#ff0000")

# p3 = ggs_autocorrelation(params %>% filter(Parameter == "V"))

gridExtra::grid.arrange(p1, p2, ncol = 1)
```

```{r seasonal-w-diagnostics, echo=FALSE, fig.cap="Diagnostic plots for the MCMC chain representing draws from the posterior distribution of the System noise covariance matrix for the simulated seasonal model"}
p1 = params %>%
  filter(Parameter %in% paste0("W", 1:7)) %>%
  ggplot(aes(x = Iteration, y = value)) +
  geom_line() +
  # geom_hline(aes(yintercept = actual_value), colour = "#ff0000") +
  facet_wrap(~Parameter, strip.position = "right")

p2 = params %>%
  group_by(Parameter) %>%
  filter(Parameter %in% paste0("W", 1:7)) %>%
  mutate(running_mean = dlm::ergMean(value)) %>%
  ggplot(aes(x = Iteration, y = running_mean)) +
  geom_line() +
  # geom_hline(aes(yintercept = actual_value), colour = "#ff0000") +
  facet_wrap(~Parameter, scales = "free_y", strip.position = "right")

gridExtra::grid.arrange(p1, p2, ncol = 1)
```

# Sample States

Testing the gibbs sampler FFBS algorithm by keeping the observation and system noise matrices constant and sampling the state using the FFBS algorithm. This is then compared to the actual state.

```{r sample_state_one, echo=FALSE, message=FALSE}
mean_state = read_csv("../data/seasonal_dlm_state_2_samples.csv", col_names = FALSE) %>%
  summarise_all(mean) %>%
  t() %>% as_data_frame() %>%
  add_column(time = 0:1000) %>%
  rename(sampled_state = V1)

mean_state %>%
  inner_join(sims %>% select(time, state2), by = "time") %>%
  gather(key, value, -time) %>%
  ggplot(aes(x = time, y = value, colour = key)) +
  geom_line()
```